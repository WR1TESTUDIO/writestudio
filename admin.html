<!DOCTYPE html>
<html lang="pl">
<head>
  <?php
session_start();
if (!isset($_SESSION['admin'])) {
  header("Location: team-login.html");
  exit;
}
?>
  <meta charset="UTF-8">
  <select id="adminSelect">
  <option disabled selected>Wybierz admina</option>
  <option value="Sandra">Sandra</option>
  <option value="Szost">Szost</option>
  <option value="NateS">NateS</option>
  <option value="Amelia">Amelia</option>
  <option value="Lesser">Lesser</option>
</select>
  <title>Panel Admina WR1TE</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f4f4;
      padding: 20px;
    }

    h1 {
      color: #2ecc71;
    }

    #users {
      margin-bottom: 20px;
    }

    #chatBox {
      background: white;
      border-radius: 12px;
      padding: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      max-width: 600px;
    }

    #chatMessages {
      height: 300px;
      overflow-y: auto;
      border: 1px solid #ccc;
      padding: 10px;
      font-size: 14px;
      white-space: pre-wrap;
      background: #fafafa;
      margin-bottom: 10px;
    }

    #replyForm {
      display: flex;
      gap: 10px;
    }

    #replyInput {
      flex: 1;
      padding: 8px;
      font-size: 14px;
    }

    #sendBtn {
      background: #2ecc71;
      color: white;
      border: none;
      padding: 10px;
      cursor: pointer;
      font-weight: bold;
    }

    select {
      padding: 6px;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <h1>WR1TE - Admin Chat Panel</h1>

  <div id="users">
    <label for="userSelect">Wybierz uÅ¼ytkownika:</label>
    <select id="userSelect"></select>
    <button onclick="loadChat()">ZaÅ‚aduj</button>
  </div>

  <div id="chatBox">
    <div id="chatMessages">Wybierz uÅ¼ytkownika, aby zobaczyÄ‡ czat</div>
    <form id="replyForm" onsubmit="sendReply(event)">
      <input type="text" id="replyInput" placeholder="OdpowiedÅº..." required />
      <button type="submit" id="sendBtn">WyÅ›lij</button>
    </form>
  </div>

  <script>
    const userSelect = document.getElementById("userSelect");
    const chatMessages = document.getElementById("chatMessages");
    const replyInput = document.getElementById("replyInput");

    async function fetchUsers() {
      const res = await fetch('list-users.php');
      const users = await res.json();
      users.forEach(user => {
        const opt = document.createElement("option");
        opt.value = user;
        opt.textContent = user;
        userSelect.appendChild(opt);
      });
    }

    async function loadChat() {
      const user = userSelect.value;
      if (!user) return;
      const res = await fetch(`chat-data/${user}`);
      const text = await res.text();
      chatMessages.textContent = text;
    }

    async function sendReply(e) {
      e.preventDefault();
      const user = userSelect.value;
      const message = replyInput.value.trim();
      if (!user || !message) return;

      await fetch('reply.php', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ user, message })
      });

      replyInput.value = "";
      loadChat();
    }

    fetchUsers();
  </script>
<script>
const categoryAdmins = {
  tekst: ["Sandra", "Szost", "NateS", "Amelia"],
  muzyka: ["Sandra", "Szost", "NateS", "Amelia"],
  "Mix/Master": ["Szost"],
  dystrybucja: ["Szost"],
  grafika: ["Lesser"],
  video: ["Lesser"]
};

const adminEmails = {
  Sandra: "sandrafieske@gmail.com",
  Szost: "szymon.szostak4@gmail.com",
  NateS: "nates1ore@gmail.com",
  Amelia: "amelia.music@wp.pl",
  Lesser: "lesser.kontakt@gmail.com"
};

let selectedAdmin = "";

document.getElementById('adminSelect').addEventListener('change', function () {
  selectedAdmin = this.value;
  localStorage.setItem("adminName", selectedAdmin);
  alert("Zalogowano jako: " + selectedAdmin);

  const email = adminEmails[selectedAdmin] || "Brak maila";
  document.getElementById("adminEmail").textContent = "ðŸ“§ " + email;
});

function showAdminsForCategory(category) {
  const list = categoryAdmins[category.toLowerCase()];
  if (!list) return "Brak przypisanych adminÃ³w";
  return list.join(", ");
}

function guessCategoryFromUser(userId) {
  // userId typu 'muzyka-192.168.1.1' -> 'muzyka'
  return userId.split("-")[0];
}

async function loadChat() {
  const user = userSelect.value;
  if (!user) return;

  const res = await fetch(`chat-data/${user}`);
  const text = await res.text();

  const category = guessCategoryFromUser(user);
  const admins = showAdminsForCategory(category);

  chatMessages.textContent =
    `ðŸ—‚ Kategoria: ${category.toUpperCase()}\nðŸ‘¥ Admini: ${admins}\n\n` +
    text;
}

async function sendReply(e) {
  e.preventDefault();
  const userId = userSelect.value;
  const message = replyInput.value.trim();
  const admin = localStorage.getItem("adminName");

  if (!userId || !message) return;

  if (!admin) {
    alert("Wybierz admina przed odpowiedziÄ…!");
    return;
  }

  await fetch('reply.php', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ userId, message, admin })
  });

  replyInput.value = "";
  loadChat();
}
</script>


</body>
</html>
